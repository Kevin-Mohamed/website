[% # config/main
   #
   # This is the main View configuration template. It is processed before
   # any other page by virtue of it being defined as a PRE_PROCESS 
   # template.  This is the place to define any extra template variables,
   # macros, load plugins, and perform any other template setup.

   IF c.config.debug;
     # define a debug() macro directed to c's log
     MACRO debug(message) CALL c.log.debug(message);
   END;

   # Site-wide data
   site = {
     copyright => '2000-2011 The WormBase Consortium',
     unknown   => 'unknown/not applicable',     # what to display if a field is empty/not applicable.
   };
  
   WB2ACE_MAP = c.model('WormBaseAPI').modelmap.WB2ACE_MAP.class;
   ACE2WB_MAP = c.model('WormBaseAPI').modelmap.ACE2WB_MAP.class;

    MACRO tag2link(data,text,title) BLOCK;  
      IF data.defined;
        UNLESS text; text = data.label; END;
        IF data.class.defined;
          ln = data.coord.start ? gbrowselink(data, data.id) : text2link(data.class, data.id, text, title, data.taxonomy);
          IF data.style;
            '<span style="'_ data.style _ "\">$ln</span>";
          ELSE;
            "$ln";
          END;
        ELSE;
          data.label || data;
        END;
      END;
   END;

   # Link a hash of objects
   # Suitable for hashes of objects created by _pack_objects()
   MACRO tags2link(data, separator, expandable_title) BLOCK;
      result = [];
      IF data.keys;
        IF data.class.defined;
          result.push(tag2link(data));
        ELSE;
          FOREACH key IN data.sort;
            result.push(tag2link(data.$key));
          END;
        END;
      ELSE;
        FOREACH item IN data;
          result.push(tag2link(item));
        END;
      END;
      IF (expandable_title && (result.size > 10));
        WRAPPER toggle title=result.size _ ' ' _ expandable_title;
          result.join(separator || '<br />');
        END;
      ELSE;
      result.join(separator || '<br />');
      END;
   END;


   MACRO get_url(class, id, taxonomy) BLOCK;
        class = (ACE2WB_MAP.$class || class) FILTER lower;
        IF c.config.sections.species.$class.defined;
          c.uri_for('/species', taxonomy || 'c_elegans' ,class, id).path;
        ELSIF (class == 'bench');
          c.uri_for('/me', id).path;
        ELSIF (class == 'page');
          id;
        ELSIF (class == 'picture');
           c.uri_for('/rest', 'widget', 'picture', id, 'lightbox').path;
        ELSIF (class == 'genomic_location');
	     # In this context, uri_for() is escaping the /? in id, breaking the URL.
	     # Would be preferable to modify creation of id, then pass it in as a query parameter perhaps?
#           c.uri_for('/tools', 'genome', 'gbrowse', id).path;
	    '/tools/genome/gbrowse/' _ id;
        ELSIF (class == 'txt');
          '';
        ELSIF !(c.config.sections.resources.$class.defined);
          c.uri_for('/search', 'all', id).path;
        ELSE;
          c.uri_for('/resources', class, id).path;
        END;
   END;

# Like tag2link, but for cases where we only have text and no object.
# You must provide both the id and text.
# URLs
    MACRO text2link(class,id,text,title,taxonomy) BLOCK;  
      class = (ACE2WB_MAP.$class || class) FILTER lower;
      IF site.external_urls.$class.defined; 
          external_link(class, text, id);
      ELSIF id.match('CHROMOSOME');
	  text;
       ELSE;
        url = get_url(class, id, taxonomy);

        IF class =='gene';
          text = markup_locus("$text", "locus", 1);
        ELSIF class =='variation' || class=='variation_name';
          text = markup_var("$text","var", 1);
        END;

        IF downloadable(class);
          "<a href='" _ c.uri_for('/rest/widget', class, id, 'sequences').path  _ '?colorbox=1' _ "' class='button ui-corner-all tl slink' data-class='$class' tip='view sequence'>";
            "<span class='ui-icon ui-icon-arrowthickstop-1-s ui-button'></span>";
          "</a>";
        END;

        url ? "<a href=\"$url\" class=\"$class-link\" title=\"$title\">$text</a>" : "$text";

      END;
   END;

    MACRO searchlink(class, id, text) BLOCK;
       url = c.uri_for('/search', class, id).path ;
       "<a href=\"$url\" class=\"$class-link\">$text</a>";
    END;

    # return true for a downloadable object
    MACRO downloadable(class) BLOCK;
      class = (class || object.name.data.class) | lower;
      ret = (class=='sequence' || class=='protein' || class=='transcript' || class=='cds' ) ? 1 : 0;
      ret;
    END;


    MACRO gbrowselink(data, label, search) BLOCK;
      valid_classes = ['gene', 'variation', 'sequence', 'transcript'];
      IF data.taxonomy && (valid_classes.grep(data.class).size > 0);
        url = c.uri_for('/tools', 'genome', 'gbrowse', data.taxonomy).path _ '?name=' _ item.name.class _ ":" _ item.name.id;
        label ? "<a href=\"$url\">$label</a>" : "<span id='fade'>[<a href=\"$url\">gbrowse</a>]</span>";
      ELSIF(!search);
        url = c.uri_for('/tools', 'genome', 'gbrowse', data.taxonomy).path;
        data.label ? "<a href=\"$url\">" _ data.label _ "</a>" : "<span id='fade'>[<a href=\"$url\">gbrowse</a>]</span>";
      END;
    END;


# use this to pluraize a word
# there exists a TT plugin which does this, but better.
#   See: Template::Plugin::Lingua::EN::Inflect
    MACRO pluralize(word, size) BLOCK;
      UNLESS word; RETURN; END;
      IF (size != 1);
	  	 IF (matches = word.match('^(.*)y$'));
		 	word = matches.0 _ 'ies';					# antibody -> antibodies
		 ELSIF (matches = word.match('^(.*)ium$'));
		 	word = matches.0 _ 'ia';					# bacterium -> bacteria
         ELSIF (matches = word.match('^(.*)cus$'));
            word = matches.0 _ 'ci';                    # locus -> loci
         ELSIF (matches = word.match('^(.*)sis$'));
            word = matches.0 _ 'ses';                   # analysis -> analyses
		 ELSIF (matches = word.match('^(.*)ius$'));
		 	word = matches.0 _ 'ii';					# radius -> radii 
         ELSIF (matches = word.match('^(.*)ss$'));
            word = matches.0 _ 'sses';                   # class -> classes 
		 ELSE; 
		 	word = word _ "s";                          # fallback
		 END;
      END;
      word;
    END;
    
# create venn type diagram with tables and colours
    MACRO venn(title_a, list_a, title_b, list_b, title_ab, list_ab, title_none, list_none) BLOCK;
    ret = "<br/><table class=\"venn\" cellspacing=\"0\" cellpadding=\"5\">";
    ret =  ret _ "<tr class=\"venn-a\"><th colspan=\"2\">$title_a</th></tr>";
          ret =  ret _ "<tr><th class=\"venn-a\"></th>";
          ret =  ret _ "<th class=\"venn-ab\"></th>";
          ret =  ret _ "<th class=\"venn-b\">$title_b</th>";
          ret =  ret _ "<th>$title_none</th>";
          ret =  ret _ "</tr>";
          ret =  ret _ "<tr class=\"venn-data\"><td class=\"venn-a\">";
        FOREACH obj IN list_a;
               ret =  ret _ "<b>" _ tag2link(obj) _ " </b>";
        END;
          ret =  ret _ "</td>";
          ret =  ret _ "<td class=\"venn-ab\">";
        FOREACH obj IN list_ab;
               ret =  ret _ "<b><i>" _ tag2link(obj) _ " </i></b>";
        END;
          ret =  ret _ "</td>";
          ret =  ret _ "<td class=\"venn-b\">";
        FOREACH obj IN list_b;
               ret =  ret _ "<i>" _ tag2link(obj) _ " </i>";
        END;
          ret =  ret _ "</td>";
          ret =  ret _ "<td>";
    
        FOREACH obj IN list_none;
               ret =  ret _ tag2link(obj) _ " ";
        END;
          ret =  ret _ "</td></tr>";
        ret =  ret _ "<tr><td></td><td class=\"venn-b\" colspan=2></td></tr>";
    ret =  ret _ "</table>";
    ret;
    END;


# Used to determine the type of page for layout saving
  MACRO page_class BLOCK;
    UNLESS (object.name.data.class);
      ret = c.req.path.replace('[/_]', '-');
      UNLESS ret;ret='home'; END;
      ret;
    ELSE; class; END;
  END;


# Use to create outgoing links from the site
# params: link          - the ID for the link found in root/templates/config/external_urls
#         text          - text displayed in the link
#         id (optional) - the unique id needed in the url.  If not provided, base url is used.
# returns: formatted html to link using url and description from config.  
#          Has google analytics code to record clicks and opens new window
    MACRO external_link(link, text, id) BLOCK;
       UNLESS text; text = id; UNLESS text; RETURN; END; END;
      #not sure why this has to be lower case since some external links are case sensitive eg. Phenobank2
      #link = link FILTER lower;
       IF (link == 'sw' OR link == 'sptrembl' OR link == 'tr'); link = 'uniprot'; END; #HACK: maybe do this somewhere else
       desc = site.external_urls.$link.description;
       IF id;
          USE String=format(site.external_urls.$link.search);
	      IF (link == 'ensembl');
             UNLESS (id.match('&')); id= 'Homo_sapiens&' _ id; END;
             array=id.split('&');
             url = String(array.first array.last);
          ELSE;
                url = String(id);
          END;
       ELSE;
          url = site.external_urls.$link.base;
       END;

       UNLESS url; url = link; END;
       "<a href=\"$url\" 
           onClick=\"WB.recordOutboundLink(this, \'Outbound Links\', \'$url\');\" 
           target=\"_blank\" title=\"$desc\">$text</a>";
    END;


    MACRO get_section(class) BLOCK;
      IF (c.config.sections.species.$class.defined);
        'species';
      ELSE;
        'resources';
      END;
    END;

# Markup any OMIM reference in a text
# marks up ALL references in the format OMIM:(\d+)
# only works for up to two references listed in a row with OMIM before only the first one
# eg. OMIM:604297, 309000
    MACRO markup_omim(text) BLOCK;
      text = "$text";
      text.replace('OMIM:(\d{6})((, )(\d{6}))?', text.search('OMIM:(\d{6})((, )(\d{6}))') ? external_link('omim','OMIM:$1', '$1') _  '$3' _ external_link('omim', '$4', '$4') : external_link('omim','OMIM:$1', '$1'));
    END;

# Markup any locus reference in text
# [A-Za-z]{3,4}-(\d){1,3}[a-z]?
    MACRO markup_locus(text, link) BLOCK;
      text = "$text";
      text.replace('(\b([A-Z][a-z]{1,2}\-)?[a-z]{3,4}-(\d+(\.\d+)?)[a-z]*( [IVXLCDM]+|\(RNAi\))?)', span_class('$1', "locus", 'gene', link));
    END;

# Markup any variation name in text
    MACRO markup_var(text, link) BLOCK;
      text = "$text";
      text.replace('(\b((\()?(ttTi|stP|hIn|[a-z]{1,3}|[a-z]*CE2-)\d+)+)', span_class('$1', "var",'variation', link));
    END;

# format taxonomy
    MACRO taxonomy(genus, species) BLOCK;
      IF species;
        g = genus.chunk(1).0 _ ".";
      ELSE;
        s = genus.split(' ');
        g = s.first.chunk(1).0 _ ".";
        species = s.last;
      END;
        "<span class=\"species\">$g $species</span>";
    END;

    MACRO span_class(text, class, ace_class, link) BLOCK;
      UNLESS link;
         "<span class=\"$class\">" _ searchlink(ace_class, text, text) _ "</span>";
      ELSE;
      "<span class=\"$class\">$text</span>";
      END;
    END;


#  Add params to have options on what to markup.  ie. omim, locus...
    MACRO markup(text, omim, locus, var, link) BLOCK;
      UNLESS (locus == 0); text = markup_locus(text, (link || 0)); END;
      UNLESS (var == 0); text = markup_var(text, (link || 0)); END;
      UNLESS (omim == 0); text = markup_omim(text); END;
      text;
    END;

     MACRO cite_image(extsrc,src) BLOCK;
           '<small>';
           IF extsrc;
              link = extsrc.template;
              FOR match IN extsrc.template.match('\<([^>]+)\>', 'global');
                  IF extsrc.template_items.size == 1; # Person heuristic
                     IF src; # there is an internal source... tag it
                        replacement = tag2link(src);
                     ELSE; # we only have their name?
                        replacement = extsrc.template_items.$match.text;
                     END;
                  ELSE;
                     replacement = external_link(extsrc.template_items.$match.url,
                                                extsrc.template_items.$match.text);
                  END;
                  link = link.replace("\<$match\>", replacement);
              END;
              link;
           ELSIF src;
              IF src.class != 'Paper'; # this is from a person
                 'Courtesy of ';
              END;
              tag2link(src);
           ELSE;
              'No reference data.';
           END;
           '</small>';
     END;

   # load up any other configuration items 
   PROCESS config/external_urls;

   # set defaults for variables, etc.
   DEFAULT 
     message = 'There is no message';

   # Set some default templates
   DEFAULT field_block  = "field_block";
   DEFAULT widget_block = "widget_block";

   # For debugging ONLY!
   USE Dumper(Indent=1);

   #######################################
   # Define some convenient macros   
   #######################################
   # image: wrap a src in an image tag using the format plugin
   USE image  = format('<img src="%s" valign="middle" width="100%">');
   USE toggle = format('<img border="0" height="11" src="%s" width="6" alt="&gt;" valign="middle"> %s');


-%]
